<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<div class="pageContent">
	<form method="post" layoutH="10"  action="role/setMenu" class="pageForm" onsubmit="return validateCallback(this,dialogAjaxDone)">
		<input type="hidden" name="roleId" value="${param.roleId}" id="roleId" />
		<input type="hidden" name="menuIds" id="menuIds"/>
		<input type="hidden" name="systemType" id="systemType"/>
		<input type="hidden"  id="menus" value="${menus}"/>
		<ul class="tree expand" layoutH="48" id="menuTree">
			<li id="system_clear"><a tname="name" tvalue="systemType" >前台结算管理系统</a>
				<ul>
					<c:forEach items="${menus}" var="item" varStatus="status">
						<c:if test="${item.parentId==0 and item.systemType==1}">
							<li id="${item.menuId}">
								<label><input type="checkbox" <c:if test="${item.checked=='true'}">class="checked"  checked</c:if>  name="menuId" value="${item.menuId}"/>${item.name}</label>
								<ul>
									<c:forEach items="${menus}" var="childTime" varStatus="childStatus">
										<c:if test="${childTime.parentId==item.menuId }">
											<li id="${childTime.menuId}_${item.menuId}">
												<label><input  type="checkbox" name="menuId" value="${childTime.menuId}"<c:if test="${childTime.checked=='true'}">class="checked"  checked</c:if>/>${childTime.name}</label>
												<ul>
													<c:forEach items="${menus}" var="child2Time" varStatus="child2Status">
														<c:if test="${child2Time.parentId==childTime.menuId}">
															<li  id="${child2Time.menuId}_${childTime.menuId}_${item.menuId}">
																<label><input type="checkbox" name="menuId"  value="${child2Time.menuId}" <c:if test="${child2Time.checked=='true'}">class="checked" checked</c:if>/>${child2Time.name}</label>
																<ul>
																	<c:forEach items="${menus}" var="child3Time">
																		<c:if test="${child3Time.parentId==child2Time.menuId}">
																			<li id="${child3Time.menuId}_${child2Time.menuId}_${childTime.menuId}_${item.menuId}">
																				<label><input type="checkbox" name="menuId" value="${child3Time.menuId}"
																							  <c:if test="${child3Time.checked=='true'}">class="checked" checked</c:if>/>
																							  ${child3Time.name}
																				</label>
																			</li>
																		</c:if>
																	</c:forEach>
																</ul>
															</li>
														</c:if>
													</c:forEach>
												</ul>
											</li>
										</c:if>
									</c:forEach>
								</ul>
							</li>
						</c:if>
					</c:forEach>
				</ul>
			</li>
			<li id="system_charge"><a tname="name" tvalue="systemType" >收费管理系统</a>
				<ul>
					<c:forEach items="${menus}" var="item" varStatus="status">
						<c:if test="${item.parentId==0 and item.systemType==2}">
							<li id="${item.menuId}">
								<label><input type="checkbox" <c:if test="${item.checked=='true'}">class="checked"  checked</c:if>  name="menuId" value="${item.menuId}"/>${item.name}</label>
								<ul>
									<c:forEach items="${menus}" var="childTime" varStatus="childStatus">
										<c:if test="${childTime.parentId==item.menuId }">
											<li id="${childTime.menuId}_${item.menuId}">
												<label><input  type="checkbox" name="menuId" value="${childTime.menuId}"<c:if test="${childTime.checked=='true'}">class="checked"  checked</c:if>/>${childTime.name}</label>
												<ul>
													<c:forEach items="${menus}" var="child2Time" varStatus="child2Status">
														<c:if test="${child2Time.parentId==childTime.menuId}">
															<li  id="${child2Time.menuId}_${childTime.menuId}_${item.menuId}">
																<label><input type="checkbox" name="menuId"  value="${child2Time.menuId}" <c:if test="${child2Time.checked=='true'}">class="checked" checked</c:if>/>${child2Time.name}</label>
																<ul>
																	<c:forEach items="${menus}" var="child3Time">
																		<c:if test="${child3Time.parentId==child2Time.menuId}">
																			<li id="${child3Time.menuId}_${child2Time.menuId}_${childTime.menuId}_${item.menuId}">
																				<label><input type="checkbox"
																							  name="menuId"
																							  value="${child3Time.menuId}"
																							  <c:if test="${child3Time.checked=='true'}">class="checked"
																							  checked</c:if>/>${child3Time.name}
																				</label>
																			</li>
																		</c:if>
																	</c:forEach>
																</ul>
															</li>
														</c:if>
													</c:forEach>
												</ul>
											</li>
										</c:if>
									</c:forEach>
								</ul>
							</li>
						</c:if>
					</c:forEach>
				</ul>
			</li>
			<li id="system_message"><a tname="name" tvalue="systemType" >数据传输监控系统</a>
				<ul>
					<c:forEach items="${menus}" var="item" varStatus="status">
						<c:if test="${item.parentId==0 and item.systemType==3}">
							<li id="${item.menuId}">
								<label><input type="checkbox" <c:if test="${item.checked=='true'}">class="checked"  checked</c:if>  name="menuId" value="${item.menuId}"/>${item.name}</label>
								<ul>
									<c:forEach items="${menus}" var="childTime" varStatus="childStatus">
										<c:if test="${childTime.parentId==item.menuId }">
											<li id="${childTime.menuId}_${item.menuId}">
												<label><input  type="checkbox" name="menuId" value="${childTime.menuId}"<c:if test="${childTime.checked=='true'}">class="checked"  checked</c:if>/>${childTime.name}</label>
												<ul>
													<c:forEach items="${menus}" var="child2Time" varStatus="child2Status">
														<c:if test="${child2Time.parentId==childTime.menuId}">
															<li  id="${child2Time.menuId}_${childTime.menuId}_${item.menuId}">
																<label><input type="checkbox" name="menuId"  value="${child2Time.menuId}" <c:if test="${child2Time.checked=='true'}">class="checked" checked</c:if>/>${child2Time.name}</label>
																<ul>
																	<c:forEach items="${menus}" var="child3Time">
																		<c:if test="${child3Time.parentId==child2Time.menuId}">
																			<li id="${child3Time.menuId}_${child2Time.menuId}_${childTime.menuId}_${item.menuId}">
																				<label><input type="checkbox"
																							  name="menuId"
																							  value="${child3Time.menuId}"
																							  <c:if test="${child3Time.checked=='true'}">class="checked"
																							  checked</c:if>/>${child3Time.name}
																				</label>
																			</li>
																		</c:if>
																	</c:forEach>
																</ul>
															</li>
														</c:if>
													</c:forEach>
												</ul>
											</li>
										</c:if>
									</c:forEach>
								</ul>
							</li>
						</c:if>
					</c:forEach>
				</ul>
			</li>
			<li id="system_user"><a tname="systemType" tvalue="" >用户管理系统</a>
				<ul>
					<c:forEach items="${menus}" var="item" varStatus="status">
						<c:if test="${item.parentId==0 and item.systemType==4}">
					<li id="${item.menuId}">
						<label><input type="checkbox" <c:if test="${item.checked=='true'}">class="checked"  checked</c:if>  name="menuId" value="${item.menuId}"/>${item.name}</label>
						<ul>
							<c:forEach items="${menus}" var="childTime" varStatus="childStatus">
								<c:if test="${childTime.parentId==item.menuId }">
							<li id="${childTime.menuId}_${item.menuId}">
								<label><input  type="checkbox" name="menuId" value="${childTime.menuId}"<c:if test="${childTime.checked=='true'}">class="checked"  checked</c:if>/>${childTime.name}</label>
								<ul>
									<c:forEach items="${menus}" var="child2Time" varStatus="child2Status">
										<c:if test="${child2Time.parentId==childTime.menuId}">
									<li  id="${child2Time.menuId}_${childTime.menuId}_${item.menuId}">
										<label><input type="checkbox" name="menuId"  value="${child2Time.menuId}" <c:if test="${child2Time.checked=='true'}">class="checked" checked</c:if>/>${child2Time.name}</label>
										<ul>
											<c:forEach items="${menus}" var="child3Time">
												<c:if test="${child3Time.parentId==child2Time.menuId}">
													<li id="${child3Time.menuId}_${child2Time.menuId}_${childTime.menuId}_${item.menuId}">
														<label><input type="checkbox" name="menuId"
																	  value="${child3Time.menuId}"
																	  <c:if test="${child3Time.checked=='true'}">class="checked"
																	  checked</c:if>/>${child3Time.name}</label>
													</li>
												</c:if>
											</c:forEach>
										</ul>
									</li>
										</c:if>
									</c:forEach>
								</ul>
							</li>
							</c:if>
							</c:forEach>
						</ul>
					</li>
					</c:if>
					</c:forEach>
				</ul>
			</li>
		</ul>
		<div class="formBar">
			<ul>
				<li><div class="buttonActive"><div class="buttonContent"><button type="submit">提交</button></div></div></li>
				<li><div class="button"><div class="buttonContent"><button type="button" class="close">取消</button></div></div></li>
			</ul>
		</div>
	</form>
</div>
<script type="text/javascript">
	$(function(){
		var menus = $("#menus").val();
		console.log(DWZ.jsonEval(menus));
		$("input").click(function(event){
			var checked = $(this).is(':checked');
			var $li = $(this).parents("li:first");
			var id= $li.attr('id');
			$li.find("input").each(function() {
				$(this).prop("checked",checked);
				if(checked){
					$(this).addClass("checked","checked");
				}else{
					$(this).removeClass("checked");
				}
			});
			var ids = id.split("_");
			for(var i=1;i<ids.length;i++){
				var prevId = "";
				for(var j=i;j<ids.length;j++){
					prevId+=ids[j];
					if(j<ids.length-1){
						prevId = prevId+("_");
					}
				}
				var size = $("#"+prevId).find("ul input[class='checked']").length;
				if(size>0){
					$("#"+prevId).find("input:first").prop("checked",true);
					$("#"+prevId).find("input:first").addClass("checked","checked");
				}else{
					$("#"+prevId).find("input:first").prop("checked",false);
					$("#"+prevId).find("input:first").removeClass("checked");
				}
			}
			var menuIdArr = [];
			$("#menuTree").find("input[class='checked']").each(function(){
				menuIdArr.push($(this).val());
			});
			$("#menuIds").val(menuIdArr.join(","));
		});
	});
</script>